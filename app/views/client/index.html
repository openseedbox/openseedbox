#{extends "main.html" /}
#{set "moreScripts"}
	<script type="text/javascript" src="#{asset.url 'javascripts/ajax-typeahead.min.js' /}"></script>
#{/set}
#{set title:"Torrents" /}
<div class="row">
	<div class="span2">
		<ul class="nav nav-pills nav-stacked nav-list">
			#{list items:groups, as:"group"}
				<li class="group #{if currentGroup == group}active#{/if}">
					<a href="@{Client.index(group)}">
						${group.length() > 15 ? group.substring(0, 15) : group}
						#{if group != "All"}
							<i class="icon-minus pull-right hide remove-group" data-group-name="${group}" rel="tooltip" title="Remove"></i>
						#{/if}
					</a>
				</li>
			#{/list}
			<li class="divider"></li>
			<li><a id="add-group-button" href="#add-group-dialog" data-toggle="modal"><i class="icon-plus"></i> Add Group</a></li>
		</ul>
	</div>
	<div class="span10">	
		#{if torrents.size > 0}
			<input id="select-all" type="checkbox" style="margin-right: 25px; margin-left: 10px; margin-top: 8px;" class="pull-left"/>
			<form id="with-selected-form" class="no-margin" action="@{Client.action}" method="post">
				<input type="hidden" name="what" value="" />
				<input type="hidden" name="hashes" value="" />
			</form>
			<div class="btn-group pull-left">
				<a class="btn dropdown-toggle" data-toggle="dropdown" href="#">With Selected <span class="caret"></span></a>
				<ul id="with-selected-dropdown" class="dropdown-menu">
					<li><a href="#" data-what="start">Start</a></li>
					<li><a href="#" data-what="stop">Pause</a></li>
					<li><a href="#" data-what="remove">Remove</a></li>				
				</ul>
			</div>
			#{/if}
		<a class="btn btn-success pull-right" data-toggle="modal" href="#add-torrent-dialog"><i class="icon-plus-sign"></i>Add Torrent</a>
		<div class="clearfix" style="margin-bottom: 5px;"></div>
		<div id="torrent-list">
			${torrentList.raw()}
		</div>
	</div>
</div>
<div class="modal hide" id="add-torrent-dialog">
	<form class="no-margin form-horizontal" enctype="multipart/form-data" method="post" action="@{Client.addTorrent}">
	<div class="modal-header">
		<a class="close" data-dismiss="modal">&times;</a>
		<h2>Add Torrent</h2>
	</div>
	<div class="modal-body">
		#{set "ajax_url"}
			#{asset.ajax /}
		#{/set}
		#{form.text label:"Search Isohunt:", name:"search", placeholder:"Enter search terms", extra:"<a id='clear' class='btn' href='#'>Clear</a><img class='hide' id='search-loader' src='${ajax_url.trim()}' />" /}
		#{form.text label:"URL or Magnet:", name:"urlOrMagnet", placeholder:"Paste torrent URL or Magnet link" /}
		#{form.upload label:"Upload from computer:", name:"fileFromComputer" /}
	</div>
	<div class="modal-footer">
		<input type="submit" class="btn btn-primary" value="Add Torrent" />
		<a href="#" class="btn" data-dismiss="modal">Close</a>
	</div>	
	</form>
</div>
<div class="modal hide" id="remove-torrent-dialog">
	<form action="@{Client.action}" method="post" class="no-margin" style="margin:0px;">
		<input name="hash" value="" type="hidden" />
		<input name="hashes" value="" type="hidden" />
		<input name="what" value="remove" type="hidden" />
		<div class="modal-header">
			<a class="close" data-dismiss="modal">&times;</a>
			<h3>Remove Torrent</h3>
		</div>	
		<div class="modal-body">
			<p>Are you sure you want to remove <strong class="torrent-name"></strong>?</p>
		</div>
		<div class="modal-footer">
			<input class="btn btn-danger" type="submit" value="Remove" />
			<a href="#" class="btn" data-dismiss="modal">Close</a>
		</div>
	</form>
</div>
<div class="modal hide" id="add-group-dialog">
	<form action="@{Client.addGroup}" method="post" class="no-margin form-horizontal" style="margin:0px;">
		<div class="modal-header">
			<a class="close" data-dismiss="modal">&times;</a>
			<h3>Add Group</h3>
		</div>	
		<div class="modal-body">
			#{form.text label:"Group Name", name:"group" /}
		</div>
		<div class="modal-footer">
			<input class="btn btn-primary" type="submit" value="Add Group" />
			<a href="#" class="btn" data-dismiss="modal">Close</a>
		</div>
	</form>
</div>	
<style type="text/css">
.no-table tr, .no-table td {
	border: 0 none;
}
.torrent-progress {
	margin-bottom: 0px;
}
.torrent-speed h5 {
	margin-left: 40px;
}

a.download-link, a.download-link:hover {
	text-decoration: none;
}

form.no-margin {
	margin: 0px;
}

.icon-loader {
	background:url("#{asset.ajax /}")
}
</style>
<script type="text/javascript">
(function($) {
	
	window.refresh_disabled = false;
	
	$(document).ajaxSuccess(function(evt, xhr) {
		try {
			var data = $.parseJSON(xhr.responseText);
			if (data.error) {
				$.flashError(data.error);
			}
		} catch (e) {
			//ignore, probably wasnt JSON that was returned
		}
	});
	
	$(document).ready(function() {
		var already_refreshing = false;
		var activeGroup = "${currentGroup}";
		var activeAjaxRequest;
		var first_time = true;
		var refresh = function(force) {
			if (first_time) { first_time = false; return; }
			if (already_refreshing && !force) {return;} //wait for previous refresh to finish before starting a new one, unless force is set
			if (window.refresh_disabled) {return;} //refresh gets disabled when window loses focus to take load off server
			already_refreshing = true;
			if (activeAjaxRequest && force) {
				activeAjaxRequest.abort();
			}
			activeAjaxRequest = $.getJSON("/client/update", {"group" : activeGroup, "ext" :"json" }, function(data) {
				
				if (!data) { return; }				

				//hide any tooltips before replacing, otherwise bootstrap loses the reference to the tooltip text
				//and it will never disappear
				$(".torrent-add-group").tooltip("hide");
				
				//update torrent list
				$("#torrent-list").html(data.data);
				
				//update tabs incase user was adding/removing groups
				//$("#tab-header").html(data.data["client-tabs"]);
				
				//process checked hashes
				$(".torrent-checkbox").each(function() {
					var my_hash = $(this).data("torrent-hash");
					if ($.inArray(my_hash, checked_hashes) != -1) {
						$(this).attr("checked", "checked");
					}					
				});
				already_refreshing = false;
			});
		};		
		setInterval(refresh, 10000); //db is only populated every 10 seconds so refreshing faster than this just causes undue load
		
		$(window).on("focus", function() {
			window.refresh_disabled = false;
			refresh(); //refresh immediately as soon as window gains focus
		}).on("blur", function() {
			window.refresh_disabled = true;
		});				
		
		//NORMAL EVENT HANDLERS		
		$(".group").mouseover(function() {
			$(this).find(".icon-minus").show();
		}).mouseout(function() {
			$(this).find(".icon-minus").hide();
		});

		$("i.remove-group").click(function() {
			var groupName = $(this).data("group-name");
			if (confirm("Are you sure you want to remove the group '" + groupName + "'?")) {
				document.location.href="@{Client.removeGroup}?group=" + groupName;
			}
			return false;
		});

		$("#select-all").click(function() {
			if ($(this).is(":checked")) {
				$(".torrent-checkbox").attr("checked", "checked");
			} else {
				$(".torrent-checkbox").removeAttr("checked");
			}
			checked_hashes = [];
			$(".torrent-checkbox").each(function() {
				if ($(this).is(":checked")) {
					checked_hashes.push($(this).data("torrent-hash"));
				}
			});
		});

		$("#with-selected-dropdown a").click(function() {
			var what = $(this).data("what");
			var checked = checked_hashes;
			if (checked.length > 0) {
				if (confirm("Are you sure you want to " + what + " these " + checked_hashes.length + " torrents?")) {
					$("#with-selected-form input[name=what]").val(what);
					$("#with-selected-form input[name=hashes]").val(checked_hashes.join(","));			
					$("#with-selected-form").submit();
					return false;	
				}
			}			
		});

		$("#search").typeahead({
			"ajax" : {
				"url" : "@{Client.searchIsohunt}",
				"displayField" : "label",
				"preDispatch" : function(query) {
					$("#search-loader").show();
					return {
						"query" : query
					}
				},
				"preProcess" : function(data) {
					$("#search-loader").hide();
					return data;
				}
			},
			"matcher" : function() { return true; },
			"display" : "label",
			"val" : "torrent_url",
			"itemSelected" : function(item, val, text) {
				$("#urlOrMagnet").val(val);
			}
		});

		$("#clear").click(function() {
			$("#search").val("");
			$("#urlOrMagnet").val("");
			return false;
		});
		
		//LIVE EVENT HANDLERS
		var checked_hashes = []; //for persisting checkboxes between requests 
				
		$("body").on("click", "a.remove-torrent", function() {
			var dialog = $("#remove-torrent-dialog");
			var hash = $(this).data("torrent-hash");
			var name = $(this).data("torrent-name");	
			$(dialog).find("input[name=hash]").val(hash);
			$(dialog).find(".torrent-name").html(name);			
			$(dialog).modal("show");
			window.refresh_disabled = true;	
			return false;
		}).on("click", "a.show-torrent-info", function() {
			var self = this;
			$(self).loading();
			$.post("/client/torrentInfo", {
				"hash" : $(this).data("torrent-hash")
			}, function(data) {
				$(self).loading();
				$("body>.container").append(data);
				$("#torrent-info-modal").modal({
					"backdrop" : false
				});
			});
			return false;
		}).on("click", ".torrent-checkbox", function() {
			var hash = $(this).data("torrent-hash");
			if ($(this).is(":checked")) {
				checked_hashes.push(hash);
			} else {
				var idx = $.inArray(hash, checked_hashes);
				if (idx != -1) {
					checked_hashes = checked_hashes.slice(idx + 1);
				}
			}
		}).on("mouseover", ".torrent-info", function() {
			$(this).find(".hide").show();
		}).on("mouseout", ".torrent-info", function() {
			$(this).find(".hide").hide();
		});	
	});
})(jQuery);

/*
 * Loading Icon plugin - replaces the first icon it finds in the element with an ajax loader
 * Flash Error plugin - easy way to flash error messages to the user
 */
(function($) {
	$.fn.loading = function() {
		return this.each(function() {
			var icon = $(this).find("i:first");
			$(icon).toggleClass("icon-loader");			
		});
	};
	$.extend({
		flashError : function(error) {
			$("#flash-error-content").html(error);
			$("#flash-error").show();
		}
	});
})(jQuery);
	</script>